# SeisMoE ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

SeisMoE (Seismic Mixture of Experts) æ˜¯åŸºäºEQTransformerçš„æ··åˆä¸“å®¶æ¨¡å‹ï¼Œé€šè¿‡å°†å‰é¦ˆç½‘ç»œæ›¿æ¢ä¸ºå¤šä¸“å®¶æ¶æ„æ¥æå‡æ¨¡å‹æ€§èƒ½å’Œè¡¨è¾¾èƒ½åŠ›ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. è®­ç»ƒSeisMoEæ¨¡å‹

```bash
# åœ¨STEADæ•°æ®é›†ä¸Šè®­ç»ƒSeisMoE
conda run -n rl python benchmark/train.py configs/stead_seismoe.json

# åœ¨ETHZæ•°æ®é›†ä¸Šå¾®è°ƒï¼ˆåªè®­ç»ƒMoEå±‚ï¼‰
conda run -n rl python benchmark/train.py configs/ethz_seismoe.json
```

### 2. è¯„ä¼°æ¨¡å‹

```bash
# è¯„ä¼°è®­ç»ƒå¥½çš„æ¨¡å‹
conda run -n rl python benchmark/eval.py --model_path weights/SeisMoE_STEAD/model.ckpt --config configs/stead_seismoe.json
```

### 3. è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œé›†æˆæµ‹è¯•
conda run -n rl python test_seismoe_integration.py
```

## ğŸ“Š æ¨¡å‹é…ç½®

### ä¸»è¦å‚æ•°

- **base_model**: åŸºç¡€EQTransformeræ¨¡å‹ (`"stead"`, `"original"`, ç­‰)
- **num_experts**: ä¸“å®¶æ•°é‡ (æ¨è: 4-16)
- **num_experts_per_token**: æ¯ä¸ªtokenä½¿ç”¨çš„ä¸“å®¶æ•° (æ¨è: 1-4)
- **moe_loss_coef**: MoEè´Ÿè½½å‡è¡¡æŸå¤±ç³»æ•° (æ¨è: 0.01-0.02)
- **freeze_non_moe**: æ˜¯å¦å†»ç»“éMoEå‚æ•° (å¾®è°ƒæ—¶è®¾ä¸ºtrue)

### é…ç½®æ–‡ä»¶ç¤ºä¾‹

**å®Œæ•´è®­ç»ƒé…ç½®** (`configs/stead_seismoe.json`):
```json
{
  "model": "SeisMoE",
  "data": "STEAD",
  "model_args": {
    "base_model": "stead",
    "num_experts": 4,
    "num_experts_per_token": 2,
    "moe_loss_coef": 0.01,
    "freeze_non_moe": false
  }
}
```

**å¾®è°ƒé…ç½®** (`configs/ethz_seismoe.json`):
```json
{
  "model": "SeisMoE", 
  "data": "ETHZ",
  "model_args": {
    "base_model": "stead",
    "num_experts": 8,
    "num_experts_per_token": 2,
    "moe_loss_coef": 0.02,
    "freeze_non_moe": true
  }
}
```

## ğŸ¯ æ¨¡å‹ç‰¹æ€§

### MoEæ¶æ„ä¼˜åŠ¿

1. **æ›´é«˜çš„æ¨¡å‹å®¹é‡**: é€šè¿‡å¤šä¸“å®¶ç½‘ç»œå¢åŠ å‚æ•°é‡ï¼Œä½†ä¿æŒè®¡ç®—æ•ˆç‡
2. **ä¸“é—¨åŒ–å­¦ä¹ **: ä¸åŒä¸“å®¶å¯ä»¥å­¦ä¹ å¤„ç†ä¸åŒç±»å‹çš„åœ°éœ‡ä¿¡å·
3. **è´Ÿè½½å‡è¡¡**: ç¡®ä¿æ‰€æœ‰ä¸“å®¶å¾—åˆ°åˆç†ä½¿ç”¨
4. **çµæ´»è®­ç»ƒ**: æ”¯æŒå…¨é‡è®­ç»ƒæˆ–åªè®­ç»ƒMoEå±‚

### æ€§èƒ½ç»Ÿè®¡

- **å‚æ•°å¢é•¿**: ç›¸æ¯”åŸå§‹EQTransformerå¢åŠ çº¦6-20%å‚æ•°
- **å¯è®­ç»ƒå‚æ•°**: 
  - å…¨é‡è®­ç»ƒ: 402,511ä¸ªå‚æ•° (100%)
  - å†»ç»“è®­ç»ƒ: 34,056ä¸ªå‚æ•° (8.5%)
- **è®¡ç®—å¼€é”€**: æ¯ä¸ªtokenåªæ¿€æ´»éƒ¨åˆ†ä¸“å®¶ï¼Œä¿æŒé«˜æ•ˆ

## ğŸ“ˆ è®­ç»ƒç­–ç•¥

### å…¨é‡è®­ç»ƒ (From Scratch)

é€‚ç”¨äºæœ‰å……è¶³æ•°æ®å’Œè®¡ç®—èµ„æºçš„æƒ…å†µï¼š

```json
{
  "model_args": {
    "freeze_non_moe": false,
    "lr": 1e-3,
    "moe_loss_coef": 0.01
  }
}
```

### å¾®è°ƒè®­ç»ƒ (Fine-tuning)

é€‚ç”¨äºç‰¹å®šæ•°æ®é›†çš„å¿«é€Ÿé€‚åº”ï¼š

```json
{
  "model_args": {
    "freeze_non_moe": true,
    "lr": 5e-4,
    "moe_loss_coef": 0.02
  }
}
```

## ğŸ”§ é«˜çº§åŠŸèƒ½

### ç¼–ç¨‹æ¥å£ä½¿ç”¨

```python
from models import SeisMoELit

# åˆ›å»ºæ¨¡å‹
model = SeisMoELit(
    base_model="stead",
    num_experts=8,
    num_experts_per_token=3,
    moe_loss_coef=0.015,
    freeze_non_moe=True
)

# è·å–MoEæŸå¤±
moe_loss = model.model.get_moe_loss()

# é‡ç½®ä¸“å®¶ä½¿ç”¨ç»Ÿè®¡
model.model.reset_moe_stats()
```

## ğŸ“‹ æµ‹è¯•ç»“æœ

âœ… **å®Œæ•´æµ‹è¯•éªŒè¯**:

1. **åŸºç¡€åŠŸèƒ½æµ‹è¯•**
   - æ¨¡å‹è¾“å‡ºå½¢çŠ¶ä¸åŸå§‹EQTransformerä¸€è‡´
   - è¾“å‡ºå€¼èŒƒå›´åœ¨æœ‰æ•ˆæ¦‚ç‡åŒºé—´å†… [0, 1]
   - å‚æ•°æ•°é‡å¢åŠ 6.8% (25,576ä¸ªå‚æ•°)

2. **MoEåŠŸèƒ½æµ‹è¯•** 
   - ä¸“å®¶è·¯ç”±æœºåˆ¶æ­£å¸¸å·¥ä½œ
   - è´Ÿè½½å‡è¡¡æŸå¤±è®¡ç®—æ­£ç¡®
   - ä¸“å®¶ä½¿ç”¨ç»Ÿè®¡è¿½è¸ªæœ‰æ•ˆ

3. **Lightningé›†æˆæµ‹è¯•**
   - SeisMoELitç±»å®ä¾‹åŒ–æˆåŠŸ
   - å‰å‘ä¼ æ’­è¾“å‡ºæ­£ç¡®
   - GPUåŠ é€Ÿæ”¯æŒæ­£å¸¸

4. **å‚æ•°å†»ç»“æµ‹è¯•**
   - å†»ç»“åŠŸèƒ½æ­£ç¡®ï¼š91.5%å‚æ•°è¢«å†»ç»“
   - åªæœ‰MoEå±‚å‚æ•°å¯è®­ç»ƒï¼ˆ36ä¸ªå¯è®­ç»ƒå±‚ï¼‰

5. **é…ç½®æ–‡ä»¶æµ‹è¯•**
   - æ‰€æœ‰é…ç½®æ–‡ä»¶æ ¼å¼æ­£ç¡®
   - èƒ½å¤ŸæˆåŠŸåˆ›å»ºå¯¹åº”æ¨¡å‹

## ğŸš¨ é‡è¦æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒè¦æ±‚**: å¿…é¡»ä½¿ç”¨`rl`ç¯å¢ƒ: `conda run -n rl python ...`
2. **åŸºç¡€æ¨¡å‹é€‰æ‹©**: æ¨èä½¿ç”¨`"stead"`ï¼Œé¿å…ä½¿ç”¨`"original"`ï¼ˆæœ‰å…¼å®¹æ€§é—®é¢˜ï¼‰
3. **GPUå†…å­˜**: å»ºè®®è‡³å°‘8GB GPUå†…å­˜ç”¨äºè®­ç»ƒ
4. **ä¸“å®¶æ•°é‡**: 
   - 4-8ä¸ªä¸“å®¶é€‚åˆå¤§å¤šæ•°æƒ…å†µ
   - è¿‡å¤šä¸“å®¶å¯èƒ½å¯¼è‡´è®­ç»ƒä¸ç¨³å®š
5. **è´Ÿè½½å‡è¡¡**: 
   - ç›‘æ§MoEæŸå¤±ç¡®ä¿ä¸“å®¶ä½¿ç”¨å‡è¡¡
   - ç³»æ•°èŒƒå›´æ¨è0.01-0.02

## ğŸ‰ æ€»ç»“

SeisMoEæˆåŠŸæ‰©å±•äº†EQTransformerï¼Œæä¾›äº†ï¼š

- ğŸš€ **æ›´å¼ºçš„è¡¨è¾¾èƒ½åŠ›**: é€šè¿‡å¤šä¸“å®¶æ¶æ„
- âš¡ **è®¡ç®—æ•ˆç‡**: ç¨€ç–æ¿€æ´»ä¿æŒæ•ˆç‡
- ğŸ¯ **çµæ´»è®­ç»ƒ**: æ”¯æŒå…¨é‡å’Œå¾®è°ƒä¸¤ç§æ¨¡å¼
- ğŸ”§ **å®Œæ•´é›†æˆ**: ä¸ç°æœ‰benchmarkæ¡†æ¶æ— ç¼å…¼å®¹

ç°åœ¨æ‚¨å¯ä»¥ä½¿ç”¨SeisMoEåœ¨åœ°éœ‡ä¿¡å·æ£€æµ‹ä»»åŠ¡ä¸Šè·å¾—æ›´å¥½çš„æ€§èƒ½ï¼